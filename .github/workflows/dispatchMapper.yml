name: Mapper

on:
  [push]
  
jobs:
  matrix_prep:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
    - name: Check out code into the Go module directory
      uses: actions/checkout@v2
    - id: set-matrix
      run: |
          content=`cat organisationMapping.json`
          content="${content//'%'/'%25'}"
          content="${content//$'\n'/'%0A'}"
          content="${content//$'\r'/'%0D'}"
          echo ::set-output name=matrix::{\"include\":$(echo $content)}\"

  RepoMatrix:
    runs-on: ubuntu-latest
    needs: matrix_prep
    strategy:
      matrix: ${{fromJson(needs.matrix_prep.outputs.matrix)}}
    steps:
    - name: Get Repo List
      id: repo
      uses: yi-Xu-0100/repo-list-generator@v1.0.1
      with:
        my_token: ${{ secrets[matrix.rat] }}
        user: ${{ matrix.organisation }}
        max_page: 100

    - name: Map repo to matrix
      run: |
        repos=${{steps.repo.outputs.repoList_ALL}}
        header="repo,dat,rat,organisation;"
        ender=",${{matrix.dat}},${{matrix.rat}},${{matrix.organisation}};"
        repocsv="$header${repos//,/$ender}$ender"
        echo $repocsv
        repojson=$($repocsv | python -c 'import csv, json, sys; print(json.dumps([dict(r) for r in csv.DictReader(sys.stdin)]))')
        echo $repojson
#        jq --slurp --raw-input --raw-output \'split("\n") | .[1:] | map(split(",")) | map({"id": .[0],
#"repo": .[1],
#"declination": .[2],
#"ultraviolet": .[3],
#"green": .[4],
#"red": .[5]})' \
#  sdss1738478.csv > sdss1738478.json
